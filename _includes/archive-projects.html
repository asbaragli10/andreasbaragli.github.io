<div class="project-item card shadow p-6 mb-8 rounded-xl">

  <!-- Title -->
  <h2 class="text-2xl font-semibold mb-3">
    {{ include.project.title }}
  </h2>

  <!-- Tech Stack -->
  {% if include.project.tech_stack %}
    <div class="tech-stack mb-4">
      <h3 class="font-semibold mb-2">Tech Stack</h3>
      <ul style="margin:0; padding-left:1rem;">
        {% for item in include.project.tech_stack %}
          <li style="margin-bottom:6px;">{{ item }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- Description -->
  {% if include.project.description %}
    <div class="project-description mb-4">
      <div class="desc-short"></div>
      <div class="desc-full" style="display:none;">
        {{ include.project.description | markdownify }}
      </div>
      <button class="read-more-btn" onclick="toggleProjectDescription(this); return false;">
        Read more
      </button>
    </div>
  {% endif %}

  <!-- Image Carousel -->
  {% if include.project.figures %}
    <div class="project-carousel mt-4">
      <div class="carousel-container">
        {% for figure in include.project.figures %}
          <div class="carousel-slide {% if forloop.first %}active{% endif %}" data-slide="{{ forloop.index0 }}">
            <img src="{{ figure | relative_url }}" alt="{{ include.project.title }} - Image {{ forloop.index }}">
          </div>
        {% endfor %}
        <button class="carousel-nav prev" onclick="changeProjectSlide(this, -1); return false;">‹</button>
        <button class="carousel-nav next" onclick="changeProjectSlide(this, 1); return false;">›</button>
      </div>
      <div class="carousel-indicators">
        {% for figure in include.project.figures %}
          <span class="carousel-indicator {% if forloop.first %}active{% endif %}" data-index="{{ forloop.index0 }}" onclick="goToProjectSlide(this); return false;"></span>
        {% endfor %}
      </div>
    </div>

  {% elsif include.project.figure %}
    <div class="project-figure mt-4">
      <img src="{{ include.project.figure | relative_url }}" alt="{{ include.project.title }}" style="width:100%; border-radius:12px;">
    </div>
  {% endif %}

</div>

<script>
(function() {
  'use strict';

  function initProjectItems() {
    /* ----- Read More Logic ----- */
    const descriptions = document.querySelectorAll(".project-description");
    descriptions.forEach(desc => {
      const fullTextEl = desc.querySelector(".desc-full");
      const shortTextEl = desc.querySelector(".desc-short");
      
      if (!fullTextEl || !shortTextEl) return;
      
      const fullText = fullTextEl.innerText || fullTextEl.textContent || '';

      // Find first and second periods
      const firstDot = fullText.indexOf(".");
      let secondDot = -1;
      if (firstDot !== -1) secondDot = fullText.indexOf(".", firstDot + 1);

      let shortText = fullText;
      if (secondDot !== -1) {
        shortText = fullText.substring(0, secondDot + 1);
      } else if (firstDot !== -1) {
        shortText = fullText.substring(0, firstDot + 1);
      }

      shortTextEl.innerText = shortText;
      shortTextEl.style.display = "inline";
    });

    /* ----- Carousel Init ----- */
    const carousels = document.querySelectorAll(".project-carousel");
    carousels.forEach(carousel => {
      const slides = carousel.querySelectorAll(".carousel-slide");
      const indicators = carousel.querySelectorAll(".carousel-indicator");

      // Ensure first slide active
      slides.forEach((s, i) => s.classList.toggle("active", i === 0));
      indicators.forEach((ind, i) => ind.classList.toggle("active", i === 0));
    });
  }

  // Run on different possible load events
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProjectItems);
  } else {
    initProjectItems();
  }

  // Also run on window load as fallback
  window.addEventListener('load', initProjectItems);

  /* ----- Toggle Read More ----- */
  window.toggleProjectDescription = function(button) {
    const container = button.closest(".project-description");
    if (!container) return;
    
    const shortText = container.querySelector(".desc-short");
    const fullText = container.querySelector(".desc-full");

    if (!shortText || !fullText) return;

    const hidden = fullText.style.display === "none" || fullText.style.display === "";

    if (hidden) {
      fullText.style.display = "block";
      shortText.style.display = "none";
      button.textContent = "Read less";
    } else {
      fullText.style.display = "none";
      shortText.style.display = "inline";
      button.textContent = "Read more";
    }
  };

  /* ----- Carousel Navigation ----- */
  window.changeProjectSlide = function(button, direction) {
    const carousel = button.closest('.project-carousel');
    if (!carousel) return;
    
    const slides = carousel.querySelectorAll('.carousel-slide');
    const indicators = carousel.querySelectorAll('.carousel-indicator');

    if (!slides.length) return;

    let currentIndex = Array.from(slides).findIndex(slide => slide.classList.contains('active'));
    if (currentIndex === -1) currentIndex = 0;
    
    let newIndex = (currentIndex + direction + slides.length) % slides.length;

    slides[currentIndex].classList.remove('active');
    slides[newIndex].classList.add('active');

    if (indicators[currentIndex]) indicators[currentIndex].classList.remove('active');
    if (indicators[newIndex]) indicators[newIndex].classList.add('active');
  };

  window.goToProjectSlide = function(indicator) {
    const index = parseInt(indicator.getAttribute('data-index'));
    const carousel = indicator.closest('.project-carousel');
    if (!carousel) return;
    
    const slides = carousel.querySelectorAll('.carousel-slide');
    const indicators = carousel.querySelectorAll('.carousel-indicator');

    slides.forEach(s => s.classList.remove('active'));
    indicators.forEach(i => i.classList.remove('active'));

    if (slides[index]) slides[index].classList.add('active');
    if (indicators[index]) indicators[index].classList.add('active');
  };

})();
</script>